#!/usr/bin/env node
import{defineCommand as mt,runMain as ut}from"citty";import{defineCommand as Ee}from"citty";import $ from"consola";import A from"node:fs/promises";import Ae from"node:os";import W from"node:path";var z=W.join(Ae.homedir(),".local","share","copilot-api"),xe=W.join(z,"github_token"),h={APP_DIR:z,GITHUB_TOKEN_PATH:xe};async function C(){await A.mkdir(h.APP_DIR,{recursive:!0}),await Ce(h.GITHUB_TOKEN_PATH)}async function Ce(e){try{await A.access(e,A.constants.W_OK)}catch{await A.writeFile(e,""),await A.chmod(e,384)}}var r={accountType:"individual",manualApprove:!1,rateLimitWait:!1,showToken:!1};import l from"consola";import pe from"node:fs/promises";import{randomUUID as Se}from"node:crypto";var d=()=>({"content-type":"application/json",accept:"application/json"}),K="0.26.7",Q=`copilot-chat/${K}`,X=`GitHubCopilotChat/${K}`,Y="2025-04-01",b=e=>e.accountType==="individual"?"https://api.githubcopilot.com":`https://api.${e.accountType}.githubcopilot.com`,k=(e,t=!1)=>{let o={Authorization:`Bearer ${e.copilotToken}`,"content-type":d()["content-type"],"copilot-integration-id":"vscode-chat","editor-version":`vscode/${e.vsCodeVersion}`,"editor-plugin-version":Q,"user-agent":X,"openai-intent":"conversation-panel","x-github-api-version":Y,"x-request-id":Se(),"x-vscode-user-agent-library-version":"electron-fetch"};return t&&(o["copilot-vision-request"]="true"),o},_="https://api.github.com",S=e=>({...d(),authorization:`token ${e.githubToken}`,"editor-version":`vscode/${e.vsCodeVersion}`,"editor-plugin-version":Q,"user-agent":X,"x-github-api-version":Y,"x-vscode-user-agent-library-version":"electron-fetch"}),v="https://github.com",R="Iv1.b507a08c87ecfe98",Z=["read:user"].join(" ");import ee from"consola";var c=class extends Error{response;constructor(t,o){super(t),this.response=o}};async function f(e,t){if(ee.error("Error occurred:",t),t instanceof c){ee.error("HTTP error:",await t.response.json());let o=await t.response.text();return e.json({error:{message:o,type:"error"}},t.response.status)}return e.json({error:{message:t.message,type:"error"}},500)}var N=async()=>{let e=await fetch(`${_}/copilot_internal/v2/token`,{headers:S(r)});if(!e.ok)throw new c("Failed to get Copilot token",e);return await e.json()};async function te(){let e=await fetch(`${v}/login/device/code`,{method:"POST",headers:d(),body:JSON.stringify({client_id:R,scope:Z})});if(!e.ok)throw new c("Failed to get device code",e);return await e.json()}async function oe(){let e=await fetch(`${_}/user`,{headers:{authorization:`token ${r.githubToken}`,...d()}});if(!e.ok)throw new c("Failed to get GitHub user",e);return await e.json()}import L from"consola";import ve from"consola";var ne=async()=>{let e=await fetch(`${b(r)}/models`,{headers:k(r)});if(!e.ok)throw new c("Failed to get models",e);return await e.json()};var re="1.98.1";async function G(){let e=new AbortController,t=setTimeout(()=>{e.abort()},5e3);try{let n=await(await fetch("https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=visual-studio-code-bin",{signal:e.signal})).text(),i=/pkgver=([0-9.]+)/,s=n.match(i);return s?s[1]:re}catch{return re}finally{clearTimeout(t)}}await G();var x=e=>new Promise(t=>{setTimeout(t,e)}),se=e=>e==null;async function P(){let e=await ne();r.models=e}var ie=async()=>{let e=await G();r.vsCodeVersion=e,ve.info(`Using VSCode version: ${e}`)};async function ae(e){let t=(e.interval+1)*1e3;for(L.debug(`Polling access token with interval of ${t}ms`);;){let o=await fetch(`${v}/login/oauth/access_token`,{method:"POST",headers:d(),body:JSON.stringify({client_id:R,device_code:e.device_code,grant_type:"urn:ietf:params:oauth:grant-type:device_code"})});if(!o.ok){await x(t),L.error("Failed to poll access token:",await o.text());continue}let n=await o.json();L.debug("Polling access token response:",n);let{access_token:i}=n;if(i)return i;await x(t)}}var Re=()=>pe.readFile(h.GITHUB_TOKEN_PATH,"utf8"),Pe=e=>pe.writeFile(h.GITHUB_TOKEN_PATH,e),le=async()=>{let{token:e,refresh_in:t}=await N();r.copilotToken=e,l.debug("GitHub Copilot Token fetched successfully!"),r.showToken&&l.info("Copilot token:",e);let o=(t-60)*1e3;setInterval(async()=>{l.debug("Refreshing Copilot token");try{let{token:n}=await N();r.copilotToken=n,l.debug("Copilot token refreshed"),r.showToken&&l.info("Refreshed Copilot token:",n)}catch(n){throw l.error("Failed to refresh Copilot token:",n),n}},o)};async function E(e){try{let t=await Re();if(t&&!e?.force){r.githubToken=t,r.showToken&&l.info("GitHub token:",t),await ce();return}l.info("Not logged in, getting new access token");let o=await te();l.debug("Device code response:",o),l.info(`Please enter the code "${o.user_code}" in ${o.verification_uri}`);let n=await ae(o);await Pe(n),r.githubToken=n,r.showToken&&l.info("GitHub token:",n),await ce()}catch(t){throw t instanceof c?(l.error("Failed to get GitHub token:",await t.response.json()),t):(l.error("Failed to get GitHub token:",t),t)}}async function ce(){let e=await oe();l.info(`Logged in as ${e.login}`)}async function He(e){e.verbose&&($.level=5,$.info("Verbose logging enabled")),r.showToken=e.showToken,await C(),await E({force:!0}),$.success("GitHub token written to",h.GITHUB_TOKEN_PATH)}var me=Ee({meta:{name:"auth",description:"Run GitHub auth flow without running the server"},args:{verbose:{alias:"v",type:"boolean",default:!1,description:"Enable verbose logging"},"show-token":{type:"boolean",default:!1,description:"Show GitHub token on auth"}},run({args:e}){return He({verbose:e.verbose,showToken:e["show-token"]})}});import{defineCommand as it}from"citty";import at from"clipboardy";import u from"consola";import{serve as ct}from"srvx";import pt from"tiny-invariant";import{execSync as Be}from"node:child_process";import Ie from"node:process";function Oe(){let{platform:e,ppid:t,env:o}=Ie;if(e==="win32"){try{let n=`wmic process get ParentProcessId,Name | findstr "${t}"`;if(Be(n,{stdio:"pipe"}).toString().toLowerCase().includes("powershell.exe"))return"powershell"}catch{return"cmd"}return"cmd"}else{let n=o.SHELL;if(n){if(n.endsWith("zsh"))return"zsh";if(n.endsWith("fish"))return"fish";if(n.endsWith("bash"))return"bash"}return"sh"}}function ue(e,t=""){let o=Oe(),n=Object.entries(e).filter(([,s])=>s!==void 0),i;switch(o){case"powershell":{i=n.map(([s,a])=>`$env:${s} = ${a}`).join("; ");break}case"cmd":{i=n.map(([s,a])=>`set ${s}=${a}`).join(" & ");break}case"fish":{i=n.map(([s,a])=>`set -gx ${s} ${a}`).join("; ");break}default:{let s=n.map(([a,m])=>`${a}=${m}`).join(" ");i=n.length>0?`export ${s}`:"";break}}return i&&t?`${i}${o==="cmd"?" & ":" && "}${t}`:i||t}import{Hono as nt}from"hono";import{cors as rt}from"hono/cors";import{logger as st}from"hono/logger";import{Hono as Le}from"hono";import w from"consola";import{streamSSE as Ne}from"hono/streaming";import Me from"consola";var H=async()=>{if(!await Me.prompt("Accept incoming request?",{type:"confirm"}))throw new c("Request rejected",Response.json({message:"Request rejected"},{status:403}))};import q from"consola";async function B(e){if(e.rateLimitSeconds===void 0)return;let t=Date.now();if(!e.lastRequestTimestamp){e.lastRequestTimestamp=t;return}let o=(t-e.lastRequestTimestamp)/1e3;if(o>e.rateLimitSeconds){e.lastRequestTimestamp=t;return}let n=Math.ceil(e.rateLimitSeconds-o);if(!e.rateLimitWait)throw q.warn(`Rate limit exceeded. Need to wait ${n} more seconds.`),new c("Rate limit exceeded",Response.json({message:"Rate limit exceeded"},{status:429}));let i=n*1e3;q.warn(`Rate limit reached. Waiting ${n} seconds before proceeding...`),await x(i),e.lastRequestTimestamp=t,q.info("Rate limit wait completed, proceeding with request")}import{countTokens as de}from"gpt-tokenizer/model/gpt-4o";var fe=e=>{let t=e.map(m=>{let T="";return typeof m.content=="string"?T=m.content:Array.isArray(m.content)&&(T=m.content.filter(g=>g.type==="text").map(g=>g.text).join("")),{...m,content:T}}),o=t.filter(m=>m.role!=="tool"),n=[],i=t.at(-1);i?.role==="assistant"&&(o=t.slice(0,-1),n=[i]);let s=de(o),a=de(n);return{input:s,output:a}};import je from"consola";import{events as Ue}from"fetch-event-stream";var I=async e=>{if(!r.copilotToken)throw new Error("Copilot token not found");let t=e.messages.some(n=>typeof n.content!="string"&&n.content?.some(i=>i.type==="image_url")),o=await fetch(`${b(r)}/chat/completions`,{method:"POST",headers:k(r,t),body:JSON.stringify(e)});if(!o.ok)throw je.error("Failed to create chat completions",o),new c("Failed to create chat completions",o);return e.stream?Ue(o):await o.json()};async function ge(e){await B(r);let t=await e.req.json();if(w.debug("Request payload:",JSON.stringify(t).slice(-400)),w.info("Current token count:",fe(t.messages)),r.manualApprove&&await H(),se(t.max_tokens)){let n=r.models?.data.find(i=>i.id===t.model);t={...t,max_tokens:n?.capabilities.limits.max_output_tokens},w.debug("Set max_tokens to:",JSON.stringify(t.max_tokens))}let o=await I(t);return Ge(o)?(w.debug("Non-streaming response:",JSON.stringify(o)),e.json(o)):(w.debug("Streaming response"),Ne(e,async n=>{for await(let i of o)w.debug("Streaming chunk:",JSON.stringify(i)),await n.writeSSE(i)}))}var Ge=e=>Object.hasOwn(e,"choices");var O=new Le;O.post("/",async e=>{try{return await ge(e)}catch(t){return await f(e,t)}});import{Hono as $e}from"hono";var he=async e=>{if(!r.copilotToken)throw new Error("Copilot token not found");let t=await fetch(`${b(r)}/embeddings`,{method:"POST",headers:k(r),body:JSON.stringify(e)});if(!t.ok)throw new c("Failed to create embeddings",t);return await t.json()};var M=new $e;M.post("/",async e=>{try{let t=await e.req.json(),o=await he(t);return e.json(o)}catch(t){return await f(e,t)}});import{Hono as Ze}from"hono";import y from"consola";import{streamSSE as Xe}from"hono/streaming";function j(e){return e===null?null:{stop:"end_turn",length:"max_tokens",tool_calls:"tool_use",content_filter:"end_turn"}[e]}function ye(e){return{model:e.model,messages:qe(e.messages,e.system),max_tokens:e.max_tokens,stop:e.stop_sequences,stream:e.stream,temperature:e.temperature,top_p:e.top_p,user:e.metadata?.user_id,tools:Je(e.tools),tool_choice:We(e.tool_choice)}}function qe(e,t){let o=De(t),n=e.flatMap(i=>i.role==="user"?Ve(i):Fe(i));return[...o,...n]}function De(e){return e?typeof e=="string"?[{role:"system",content:e}]:[{role:"system",content:e.map(o=>o.text).join(`

`)}]:[]}function Ve(e){let t=[];if(Array.isArray(e.content)){let o=e.content.filter(s=>s.type==="tool_result"),n=e.content.filter(s=>s.type==="text"),i=e.content.filter(s=>s.type!=="tool_result"&&s.type!=="text");for(let s of o)t.push({role:"tool",tool_call_id:s.tool_use_id,content:typeof s.content=="string"?s.content:JSON.stringify(s.content)});if(n.length>0||i.length>0){let s=[...n.map(a=>a.text),...i.map(a=>JSON.stringify(a))].join(`

`).trim();s.length>0&&t.push({role:"user",content:s})}}else t.push({role:"user",content:D(e.content)});return t}function Fe(e){if(!Array.isArray(e.content))return[{role:"assistant",content:D(e.content)}];let t=e.content.filter(n=>n.type==="tool_use"),o=e.content.filter(n=>n.type==="text");return t.length>0?[{role:"assistant",content:o.map(n=>n.text).join(`

`)||null,tool_calls:t.map(n=>({id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.input)}}))}]:[{role:"assistant",content:D(e.content)}]}function D(e){if(typeof e=="string")return e;if(!Array.isArray(e))return null;if(!e.some(n=>n.type==="image"))return e.filter(n=>n.type==="text").map(n=>n.text).join(`

`);let o=[];for(let n of e)n.type==="text"?o.push({type:"text",text:n.text}):n.type==="image"&&o.push({type:"image_url",image_url:{url:`data:${n.source.media_type};base64,${n.source.data}`}});return o}function Je(e){if(e)return e.map(t=>({type:"function",function:{name:t.name,description:t.description,parameters:t.input_schema}}))}function We(e){if(e)switch(e.type){case"auto":return"auto";case"any":return"required";case"tool":return e.name?{type:"function",function:{name:e.name}}:void 0;case"none":return"none";default:return}}function be(e){let t=e.choices[0],o=ze(t.message.content),n=Ke(t.message.tool_calls);return{id:e.id,type:"message",role:"assistant",model:e.model,content:[...o,...n],stop_reason:j(t.finish_reason),stop_sequence:null,usage:{input_tokens:e.usage?.prompt_tokens??0,output_tokens:e.usage?.completion_tokens??0}}}function ze(e){return typeof e=="string"?[{type:"text",text:e}]:Array.isArray(e)?e.filter(t=>t.type==="text").map(t=>({type:"text",text:t.text})):[]}function Ke(e){return e?e.map(t=>({type:"tool_use",id:t.id,name:t.function.name,input:JSON.parse(t.function.arguments)})):[]}function Qe(e){return e.contentBlockOpen?Object.values(e.toolCalls).some(t=>t.anthropicBlockIndex===e.contentBlockIndex):!1}function ke(e,t){let o=[];if(e.choices.length===0)return o;let n=e.choices[0],{delta:i}=n;if(t.messageStartSent||(o.push({type:"message_start",message:{id:e.id,type:"message",role:"assistant",content:[],model:e.model,stop_reason:null,stop_sequence:null,usage:{input_tokens:1,output_tokens:1}}}),t.messageStartSent=!0),i.content&&(Qe(t)&&(o.push({type:"content_block_stop",index:t.contentBlockIndex}),t.contentBlockIndex++,t.contentBlockOpen=!1),t.contentBlockOpen||(o.push({type:"content_block_start",index:t.contentBlockIndex,content_block:{type:"text",text:""}}),t.contentBlockOpen=!0),o.push({type:"content_block_delta",index:t.contentBlockIndex,delta:{type:"text_delta",text:i.content}})),i.tool_calls)for(let s of i.tool_calls){if(s.id&&s.function?.name){t.contentBlockOpen&&(o.push({type:"content_block_stop",index:t.contentBlockIndex}),t.contentBlockIndex++,t.contentBlockOpen=!1);let a=t.contentBlockIndex;t.toolCalls[s.index]={id:s.id,name:s.function.name,anthropicBlockIndex:a},o.push({type:"content_block_start",index:a,content_block:{type:"tool_use",id:s.id,name:s.function.name,input:{}}}),t.contentBlockOpen=!0}if(s.function?.arguments){let a=t.toolCalls[s.index];a&&o.push({type:"content_block_delta",index:a.anthropicBlockIndex,delta:{type:"input_json_delta",partial_json:s.function.arguments}})}}return n.finish_reason&&(t.contentBlockOpen&&(o.push({type:"content_block_stop",index:t.contentBlockIndex}),t.contentBlockOpen=!1),o.push({type:"message_delta",delta:{stop_reason:j(n.finish_reason),stop_sequence:null},usage:{output_tokens:1}}),o.push({type:"message_stop"})),o}async function _e(e){await B(r);let t=await e.req.json();y.debug("Anthropic request payload:",JSON.stringify(t));let o=ye(t);y.debug("Translated OpenAI request payload:",JSON.stringify(o)),r.manualApprove&&await H();let n=await I(o);if(Ye(n)){y.debug("Non-streaming response from Copilot:",JSON.stringify(n).slice(-400));let i=be(n);return y.debug("Translated Anthropic response:",JSON.stringify(i)),e.json(i)}return y.debug("Streaming response from Copilot"),Xe(e,async i=>{let s={messageStartSent:!1,contentBlockIndex:0,contentBlockOpen:!1,toolCalls:{}};for await(let a of n){if(y.debug("Copilot raw stream event:",JSON.stringify(a)),a.data==="[DONE]")break;if(!a.data)continue;let m=JSON.parse(a.data),T=ke(m,s);for(let g of T)y.debug("Translated Anthropic event:",JSON.stringify(g)),await i.writeSSE({event:g.type,data:JSON.stringify(g)})}})}var Ye=e=>Object.hasOwn(e,"choices");var V=new Ze;V.post("/",async e=>{try{return await _e(e)}catch(t){return await f(e,t)}});import{Hono as et}from"hono";var U=new et;U.get("/",async e=>{try{r.models||await P();let t=r.models?.data.map(o=>({id:o.id,object:"model",type:"model",created:0,created_at:new Date(0).toISOString(),owned_by:o.vendor,display_name:o.name}));return e.json({object:"list",data:t,has_more:!1})}catch(t){return await f(e,t)}});import{Hono as tt}from"hono";var F=new tt;F.get("/",e=>{try{return e.json({token:r.copilotToken})}catch(t){return console.error("Error fetching token:",t),e.json({error:"Failed to fetch token",token:null},500)}});import{Hono as ot}from"hono";var we=async()=>{let e=await fetch(`${_}/copilot_internal/user`,{headers:S(r)});if(!e.ok)throw new c("Failed to get Copilot usage",e);return await e.json()};var J=new ot;J.get("/",async e=>{try{let t=await we();return e.json(t)}catch(t){return console.error("Error fetching Copilot usage:",t),e.json({error:"Failed to fetch Copilot usage"},500)}});var p=new nt;p.use(st());p.use(rt());p.get("/",e=>e.text("Server running"));p.route("/chat/completions",O);p.route("/models",U);p.route("/embeddings",M);p.route("/usage",J);p.route("/token",F);p.route("/v1/chat/completions",O);p.route("/v1/models",U);p.route("/v1/embeddings",M);p.route("/v1/messages",V);p.post("/v1/messages/count_tokens",e=>e.json({input_tokens:1}));async function lt(e){e.verbose&&(u.level=5,u.info("Verbose logging enabled")),r.accountType=e.accountType,e.accountType!=="individual"&&u.info(`Using ${e.accountType} plan GitHub account`),r.manualApprove=e.manual,r.rateLimitSeconds=e.rateLimit,r.rateLimitWait=e.rateLimitWait,r.showToken=e.showToken,await C(),await ie(),e.githubToken?(r.githubToken=e.githubToken,u.info("Using provided GitHub token")):await E(),await le(),await P(),u.info(`Available models: 
${r.models?.data.map(o=>`- ${o.id}`).join(`
`)}`);let t=`http://localhost:${e.port}`;if(e.claudeCode){pt(r.models,"Models should be loaded by now");let o=await u.prompt("Select a model to use with Claude Code",{type:"select",options:r.models.data.map(s=>s.id)}),n=await u.prompt("Select a small model to use with Claude Code",{type:"select",options:r.models.data.map(s=>s.id)}),i=ue({ANTHROPIC_BASE_URL:t,ANTHROPIC_AUTH_TOKEN:"dummy",ANTHROPIC_MODEL:o,ANTHROPIC_SMALL_FAST_MODEL:n},"claude");at.writeSync(i),u.success("Copied Claude Code command to clipboard!")}u.box(`\u{1F310} Usage Viewer: https://ericc-ch.github.io/copilot-api?endpoint=${t}/usage`),ct({fetch:p.fetch,port:e.port})}var Te=it({meta:{name:"start",description:"Start the Copilot API server"},args:{port:{alias:"p",type:"string",default:"4141",description:"Port to listen on"},verbose:{alias:"v",type:"boolean",default:!1,description:"Enable verbose logging"},"account-type":{alias:"a",type:"string",default:"individual",description:"Account type to use (individual, business, enterprise)"},manual:{type:"boolean",default:!1,description:"Enable manual request approval"},"rate-limit":{alias:"r",type:"string",description:"Rate limit in seconds between requests"},wait:{alias:"w",type:"boolean",default:!1,description:"Wait instead of error when rate limit is hit. Has no effect if rate limit is not set"},"github-token":{alias:"g",type:"string",description:"Provide GitHub token directly (must be generated using the `auth` subcommand)"},"claude-code":{alias:"c",type:"boolean",default:!1,description:"Generate a command to launch Claude Code with Copilot API config"},"show-token":{type:"boolean",default:!1,description:"Show GitHub and Copilot tokens on fetch and refresh"}},run({args:e}){let t=e["rate-limit"],o=t===void 0?void 0:Number.parseInt(t,10);return lt({port:Number.parseInt(e.port,10),verbose:e.verbose,accountType:e["account-type"],manual:e.manual,rateLimit:o,rateLimitWait:!!e.wait,githubToken:e["github-token"],claudeCode:e["claude-code"],showToken:e["show-token"]})}});var dt=mt({meta:{name:"copilot-api",description:"A wrapper around GitHub Copilot API to make it OpenAI compatible, making it usable for other tools."},subCommands:{auth:me,start:Te}});await ut(dt);
